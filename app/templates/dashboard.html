{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Top Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Total Balance Card -->
        <div class="bg-gradient-to-r from-indigo-900 to-purple-900 rounded-lg shadow-lg p-6 text-white transform hover:scale-105 transition duration-300 border border-indigo-700">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-indigo-200 text-sm font-medium">总净值 (USD)</p>
                    <h2 id="total-balance" class="text-3xl font-bold mt-1">--</h2>
                </div>
                <div class="p-2 bg-white bg-opacity-10 rounded-full">
                    <svg class="w-6 h-6 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm text-indigo-200">
                <button id="refreshBtn" class="flex items-center hover:text-white transition-colors underline">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    点击刷新数据
                </button>
            </div>
        </div>

        <!-- Binance Card -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Binance</p>
                    <h2 id="binance-balance" class="text-2xl font-bold text-gray-100 mt-1">--</h2>
                </div>
                <img src="https://cryptologos.cc/logos/binance-coin-bnb-logo.png?v=026" class="w-8 h-8 opacity-80" alt="Binance">
            </div>
        </div>

        <!-- OKX Card -->
        <div class="bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-gray-500">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-gray-400 text-sm font-medium">OKX</p>
                    <h2 id="okx-balance" class="text-2xl font-bold text-gray-100 mt-1">--</h2>
                </div>
                <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center text-white font-bold text-xs border border-gray-600">OKX</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-gray-100">历史净值曲线</h3>
            <div class="flex space-x-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-900 text-indigo-200 border border-indigo-700">Total</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-900 text-yellow-200 border border-yellow-700">Binance</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300 border border-gray-600">OKX</span>
            </div>
        </div>
        <div class="relative h-72">
            <canvas id="historyChart"></canvas>
        </div>
    </div>

    <!-- Assets Distribution -->
    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
        <h3 class="text-lg font-bold mb-6 text-gray-100">持仓详情</h3>
        
        <div class="mb-4 border-b border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="assetsTab" role="tablist">
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 rounded-t-lg border-b-2 border-indigo-400 text-indigo-400 active" id="all-tab" type="button" role="tab">所有资产</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-300 hover:border-gray-600 text-gray-400" id="binance-tab" type="button" role="tab">Binance</button>
                </li>
                <li class="mr-2" role="presentation">
                    <button class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-300 hover:border-gray-600 text-gray-400" id="okx-tab" type="button" role="tab">OKX</button>
                </li>
            </ul>
        </div>
        
        <div id="assetsTabContent">
            <div class="hidden p-4 rounded-lg bg-gray-900 border border-gray-700" id="all" role="tabpanel">
                <div id="all-assets-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            <div class="hidden p-4 rounded-lg bg-gray-900 border border-gray-700" id="binance" role="tabpanel">
                <div id="binance-assets-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            <div class="hidden p-4 rounded-lg bg-gray-900 border border-gray-700" id="okx" role="tabpanel">
                <div id="okx-assets-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const token = localStorage.getItem('access_token');
    if (!token) window.location.href = '/login';

    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };

    // --- Tabs Logic ---
    const tabs = ['all', 'binance', 'okx'];
    tabs.forEach(tab => {
        const btn = document.getElementById(`${tab}-tab`);
        btn.addEventListener('click', () => {
            tabs.forEach(t => {
                const el = document.getElementById(`${t}-tab`);
                el.classList.remove('border-indigo-400', 'text-indigo-400', 'active');
                el.classList.add('border-transparent', 'hover:text-gray-300', 'hover:border-gray-600', 'text-gray-400');
                document.getElementById(t).classList.add('hidden');
            });
            btn.classList.add('border-indigo-400', 'text-indigo-400', 'active');
            btn.classList.remove('border-transparent', 'hover:text-gray-300', 'hover:border-gray-600', 'text-gray-400');
            document.getElementById(tab).classList.remove('hidden');
        });
    });
    // Activate first tab
    document.getElementById('all-tab').click();


    // Load History Chart
    let chartInstance = null;
    async function loadHistory() {
        const res = await fetch('/api/history', { headers });
        const data = await res.json();
        
        // Data is newest first
        const history = data.reverse();
        
        if (history.length === 0) return;

        // Process datasets
        const labels = history.map(h => new Date(h.timestamp).toLocaleDateString());
        
        const totalData = history.map(h => h.total_balance_usd);
        const binanceData = history.map(h => {
            if (h.details && h.details.exchanges && h.details.exchanges.binance) {
                return h.details.exchanges.binance.total_usd;
            }
            return 0;
        });
        const okxData = history.map(h => {
            if (h.details && h.details.exchanges && h.details.exchanges.okx) {
                return h.details.exchanges.okx.total_usd;
            }
            return 0;
        });

        // Update latest state on page load from history if available
        const latest = history[history.length - 1];
        if (latest) {
            updateDashboard(latest.total_balance_usd, latest.details);
        }

        const ctx = document.getElementById('historyChart').getContext('2d');
        
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total',
                        data: totalData,
                        borderColor: 'rgb(129, 140, 248)', // Indigo-400
                        backgroundColor: 'rgba(129, 140, 248, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Binance',
                        data: binanceData,
                        borderColor: 'rgb(250, 204, 21)', // Yellow-400
                        backgroundColor: 'rgba(250, 204, 21, 0.0)',
                        tension: 0.3,
                        borderDash: [5, 5],
                        fill: false
                    },
                    {
                        label: 'OKX',
                        data: okxData,
                        borderColor: 'rgb(156, 163, 175)', // Gray-400
                        backgroundColor: 'rgba(156, 163, 175, 0.0)',
                        tension: 0.3,
                        borderDash: [2, 2],
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#D1D5DB' // Gray-300
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { 
                            display: false,
                            color: '#374151' // Gray-700
                        },
                        ticks: {
                            color: '#9CA3AF' // Gray-400
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { 
                            borderDash: [2, 4],
                            color: '#374151' // Gray-700
                        },
                        ticks: {
                            color: '#9CA3AF' // Gray-400
                        }
                    }
                }
            }
        });
    }

    function updateDashboard(totalBalance, details) {
        // Update Total Balance
        document.getElementById('total-balance').textContent = 
            new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalBalance);
        
        // Update Binance Balance
        const binanceBal = details?.exchanges?.binance?.total_usd || 0;
        document.getElementById('binance-balance').textContent = 
            new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(binanceBal);
            
        // Update OKX Balance
        const okxBal = details?.exchanges?.okx?.total_usd || 0;
        document.getElementById('okx-balance').textContent = 
            new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(okxBal);
            
        // Update Assets List
        updateAssetsList('all-assets-list', details?.exchanges?.binance?.balances, details?.exchanges?.okx?.balances);
        updateAssetsList('binance-assets-list', details?.exchanges?.binance?.balances);
        updateAssetsList('okx-assets-list', null, details?.exchanges?.okx?.balances);
    }

    function updateAssetsList(containerId, binanceBalances, okxBalances) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        let allAssets = [];
        
        if (binanceBalances) {
            Object.entries(binanceBalances).forEach(([symbol, amount]) => {
                if (parseFloat(amount) > 0) {
                    allAssets.push({ symbol, amount, source: 'Binance' });
                }
            });
        }
        
        if (okxBalances) {
            Object.entries(okxBalances).forEach(([symbol, amount]) => {
                if (parseFloat(amount) > 0) {
                    allAssets.push({ symbol, amount, source: 'OKX' });
                }
            });
        }
        
        // Merge same assets if showing all (optional, current logic just lists them)
        // For simplicity, we just list them. If needed, we can merge.
        
        if (allAssets.length === 0) {
            container.innerHTML = '<p class="col-span-full text-gray-500 text-sm italic">暂无持仓</p>';
            return;
        }

        allAssets.forEach(asset => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between bg-gray-700 p-3 rounded border border-gray-600';
            div.innerHTML = `
                <div>
                    <span class="font-bold text-gray-200">${asset.symbol}</span>
                    <span class="text-xs text-gray-400 block">${asset.source}</span>
                </div>
                <span class="font-mono text-gray-300">${parseFloat(asset.amount).toFixed(4)}</span>
            `;
            container.appendChild(div);
        });
    }
    
    // Refresh Logic
    async function triggerRefresh() {
        const btn = document.getElementById('refreshBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            刷新中...
        `;
        
        try {
            await fetch('/api/refresh', { method: 'POST', headers });
            await loadHistory();
        } catch (e) {
            console.error(e);
            alert('刷新失败');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    document.getElementById('refreshBtn').addEventListener('click', triggerRefresh);

    // Initial Load
    (async () => {
        await loadHistory();
    })();
</script>
{% endblock %}